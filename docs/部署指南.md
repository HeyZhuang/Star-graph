# Star-Graph 部署指南

## 目录

1. [部署概述](#1-部署概述)
2. [环境准备](#2-环境准备)
3. [开发环境部署](#3-开发环境部署)
4. [Docker部署](#4-docker部署)
5. [Kubernetes部署](#5-kubernetes部署)
6. [生产环境部署](#6-生产环境部署)
7. [监控与运维](#7-监控与运维)
8. [故障排查](#8-故障排查)
9. [性能优化](#9-性能优化)
10. [备份与恢复](#10-备份与恢复)

## 1. 部署概述

### 1.1 系统架构

Star-Graph采用前后端分离的微服务架构：

```
组件架构:
├── 前端应用 (Vue 3 + Nginx)
├── 后端服务 (Spring Boot)
├── 数据库 (MySQL 8.0)
├── 缓存服务 (Redis 7.x)
├── AI服务 (ComfyUI)
└── 对象存储 (MinIO)
```

### 1.2 部署模式

| 部署模式 | 适用场景 | 优势 | 劣势 |
|---------|---------|------|------|
| 单机部署 | 开发测试 | 简单快速 | 性能有限 |
| Docker部署 | 中小规模 | 易于管理 | 需要Docker知识 |
| Kubernetes | 大规模生产 | 高可用、自动扩缩容 | 复杂度高 |
| 云原生部署 | 企业级应用 | 弹性伸缩、按需付费 | 成本较高 |

### 1.3 硬件要求

**最低配置**:
```yaml
CPU: 4核心
内存: 8GB
磁盘: 100GB SSD
GPU: NVIDIA RTX 3060 (12GB显存)
网络: 100Mbps
```

**推荐配置**:
```yaml
CPU: 8核心以上
内存: 32GB以上
磁盘: 500GB NVMe SSD
GPU: NVIDIA RTX 4090 (24GB显存)
网络: 1Gbps
```

## 2. 环境准备

### 2.1 操作系统

支持的操作系统：
- Ubuntu 20.04/22.04 LTS
- CentOS 7/8
- Debian 11/12
- Windows Server 2019/2022
- macOS 12+ (仅开发环境)

### 2.2 基础软件

```bash
# 更新系统包
sudo apt update && sudo apt upgrade -y

# 安装基础工具
sudo apt install -y \
    curl \
    wget \
    git \
    vim \
    htop \
    net-tools \
    build-essential \
    software-properties-common
```

### 2.3 Java环境

```bash
# 安装OpenJDK 17
sudo apt install -y openjdk-17-jdk

# 验证安装
java -version
javac -version

# 设置JAVA_HOME
echo 'export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64' >> ~/.bashrc
echo 'export PATH=$JAVA_HOME/bin:$PATH' >> ~/.bashrc
source ~/.bashrc
```

### 2.4 Node.js环境

```bash
# 使用NodeSource安装Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# 验证安装
node -v
npm -v

# 安装yarn (可选)
npm install -g yarn

# 安装pnpm (可选)
npm install -g pnpm
```

### 2.5 数据库安装

**MySQL 8.0**:
```bash
# 安装MySQL
sudo apt install -y mysql-server

# 安全配置
sudo mysql_secure_installation

# 创建数据库和用户
sudo mysql -u root -p << EOF
CREATE DATABASE star_graph DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'stargraph'@'%' IDENTIFIED BY 'StrongPassword123!';
GRANT ALL PRIVILEGES ON star_graph.* TO 'stargraph'@'%';
FLUSH PRIVILEGES;
EOF

# 配置远程访问
sudo sed -i 's/bind-address.*/bind-address = 0.0.0.0/' /etc/mysql/mysql.conf.d/mysqld.cnf
sudo systemctl restart mysql
```

### 2.6 Redis安装

```bash
# 安装Redis
sudo apt install -y redis-server

# 配置Redis
sudo sed -i 's/^# requirepass.*/requirepass YourRedisPassword/' /etc/redis/redis.conf
sudo sed -i 's/^bind 127.0.0.1/bind 0.0.0.0/' /etc/redis/redis.conf

# 启动Redis
sudo systemctl enable redis-server
sudo systemctl start redis-server

# 验证连接
redis-cli -a YourRedisPassword ping
```

### 2.7 NVIDIA驱动和CUDA

```bash
# 添加NVIDIA包仓库
distribution=$(. /etc/os-release;echo $ID$VERSION_ID)
curl -s -L https://nvidia.github.io/libnvidia-container/gpgkey | sudo apt-key add -
curl -s -L https://nvidia.github.io/libnvidia-container/$distribution/libnvidia-container.list | sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list

# 安装NVIDIA驱动
sudo apt update
sudo apt install -y nvidia-driver-535

# 安装CUDA Toolkit
wget https://developer.download.nvidia.com/compute/cuda/12.2.0/local_installers/cuda_12.2.0_535.54.03_linux.run
sudo sh cuda_12.2.0_535.54.03_linux.run

# 配置环境变量
echo 'export PATH=/usr/local/cuda/bin:$PATH' >> ~/.bashrc
echo 'export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH' >> ~/.bashrc
source ~/.bashrc

# 验证安装
nvidia-smi
nvcc --version
```

## 3. 开发环境部署

### 3.1 克隆项目

```bash
# 克隆代码仓库
git clone https://github.com/HeyZhuang/Star-graph.git
cd Star-graph
```

### 3.2 后端部署

```bash
cd star-graph

# 配置数据库连接
vim src/main/resources/application.yml
```

**application.yml配置**:
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/star_graph?useSSL=false&serverTimezone=UTC
    username: stargraph
    password: StrongPassword123!
    driver-class-name: com.mysql.cj.jdbc.Driver
    
  redis:
    host: localhost
    port: 6379
    password: YourRedisPassword
    database: 0

server:
  port: 8080
  
# ComfyUI配置
comfyui:
  url: http://localhost:8188
  ws-url: ws://localhost:8188/ws
```

```bash
# 编译项目
mvn clean package

# 运行开发服务器
mvn spring-boot:run

# 或者运行JAR包
java -jar target/star-graph-1.0.0.jar
```

### 3.3 前端部署

```bash
cd star-graph-ui完整前端/star-graph-ui

# 安装依赖
npm install

# 配置环境变量
cp .env.development .env.local
vim .env.local
```

**.env.local配置**:
```env
VITE_APP_BASE_API=/dev-api
VITE_APP_WS_URL=ws://localhost:8080/ws
```

```bash
# 启动开发服务器
npm run dev

# 访问地址: http://localhost:5173
```

### 3.4 ComfyUI部署

```bash
# 克隆ComfyUI
git clone https://github.com/comfyanonymous/ComfyUI.git
cd ComfyUI

# 创建Python虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

# 下载模型
cd models/checkpoints
wget https://huggingface.co/stabilityai/stable-diffusion-xl-base-1.0/resolve/main/sd_xl_base_1.0.safetensors

# 启动ComfyUI
python main.py --listen 0.0.0.0 --port 8188
```

## 4. Docker部署

### 4.1 安装Docker

```bash
# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 添加当前用户到docker组
sudo usermod -aG docker $USER
newgrp docker

# 验证安装
docker --version
docker-compose --version
```

### 4.2 构建镜像

**后端Dockerfile**:
```dockerfile
FROM openjdk:17-jdk-slim
WORKDIR /app
COPY target/star-graph-1.0.0.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
```

**前端Dockerfile**:
```dockerfile
# 构建阶段
FROM node:18-alpine as builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build-prod

# 运行阶段
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

### 4.3 Docker Compose部署

**docker-compose.yml**:
```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: star-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root123456
      MYSQL_DATABASE: star_graph
      MYSQL_USER: stargraph
      MYSQL_PASSWORD: StrongPassword123!
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql:/docker-entrypoint-initdb.d
    ports:
      - "3306:3306"
    networks:
      - star-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: star-redis
    command: redis-server --requirepass YourRedisPassword
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - star-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "YourRedisPassword", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build: ./star-graph
    container_name: star-backend
    environment:
      SPRING_PROFILES_ACTIVE: docker
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: star_graph
      DB_USER: stargraph
      DB_PASSWORD: StrongPassword123!
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: YourRedisPassword
    ports:
      - "8080:8080"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - star-network
    restart: unless-stopped

  frontend:
    build: ./star-graph-ui完整前端/star-graph-ui
    container_name: star-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - star-network
    restart: unless-stopped

  comfyui:
    build: ./comfyui
    container_name: star-comfyui
    ports:
      - "8188:8188"
    volumes:
      - ./models:/app/models
      - ./output:/app/output
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    networks:
      - star-network
    restart: unless-stopped

volumes:
  mysql_data:
  redis_data:

networks:
  star-network:
    driver: bridge
```

启动服务:
```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f backend

# 停止服务
docker-compose down

# 停止并删除数据
docker-compose down -v
```

## 5. Kubernetes部署

### 5.1 安装Kubernetes

```bash
# 安装kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

# 安装Minikube (开发环境)
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube

# 启动Minikube
minikube start --driver=docker --cpus=4 --memory=8192

# 或者安装K3s (轻量级)
curl -sfL https://get.k3s.io | sh -
```

### 5.2 创建命名空间

```bash
kubectl create namespace star-graph
kubectl config set-context --current --namespace=star-graph
```

### 5.3 部署配置

**ConfigMap配置**:
```yaml
# configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: star-graph-config
  namespace: star-graph
data:
  application.yml: |
    spring:
      profiles:
        active: k8s
      datasource:
        url: jdbc:mysql://mysql-service:3306/star_graph
        username: stargraph
        password: StrongPassword123!
      redis:
        host: redis-service
        port: 6379
        password: YourRedisPassword
    server:
      port: 8080
```

**Secret配置**:
```yaml
# secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: star-graph-secret
  namespace: star-graph
type: Opaque
data:
  db-password: U3Ryb25nUGFzc3dvcmQxMjMh  # base64编码
  redis-password: WW91clJlZGlzUGFzc3dvcmQ=  # base64编码
```

### 5.4 数据库部署

```yaml
# mysql-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
  namespace: star-graph
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: star-graph-secret
              key: db-password
        - name: MYSQL_DATABASE
          value: star_graph
        ports:
        - containerPort: 3306
        volumeMounts:
        - name: mysql-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: mysql-storage
        persistentVolumeClaim:
          claimName: mysql-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: mysql-service
  namespace: star-graph
spec:
  selector:
    app: mysql
  ports:
  - port: 3306
    targetPort: 3306
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
  namespace: star-graph
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
```

### 5.5 应用部署

```yaml
# app-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: star-graph-backend
  namespace: star-graph
spec:
  replicas: 3
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: backend
        image: star-graph-backend:latest
        ports:
        - containerPort: 8080
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: k8s
        volumeMounts:
        - name: config
          mountPath: /app/config
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /actuator/ready
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 5
      volumes:
      - name: config
        configMap:
          name: star-graph-config
---
apiVersion: v1
kind: Service
metadata:
  name: backend-service
  namespace: star-graph
spec:
  selector:
    app: backend
  ports:
  - port: 8080
    targetPort: 8080
  type: LoadBalancer
```

### 5.6 Ingress配置

```yaml
# ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: star-graph-ingress
  namespace: star-graph
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
  - hosts:
    - api.star-graph.com
    secretName: star-graph-tls
  rules:
  - host: api.star-graph.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: backend-service
            port:
              number: 8080
```

### 5.7 自动扩缩容

```yaml
# hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: backend-hpa
  namespace: star-graph
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: star-graph-backend
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

部署到集群:
```bash
# 应用所有配置
kubectl apply -f configmap.yaml
kubectl apply -f secret.yaml
kubectl apply -f mysql-deployment.yaml
kubectl apply -f app-deployment.yaml
kubectl apply -f ingress.yaml
kubectl apply -f hpa.yaml

# 查看部署状态
kubectl get all -n star-graph

# 查看日志
kubectl logs -f deployment/star-graph-backend -n star-graph
```

## 6. 生产环境部署

### 6.1 负载均衡

**Nginx配置**:
```nginx
# /etc/nginx/sites-available/star-graph
upstream backend {
    least_conn;
    server backend1.star-graph.com:8080 weight=3;
    server backend2.star-graph.com:8080 weight=2;
    server backend3.star-graph.com:8080 weight=1;
    
    keepalive 32;
}

server {
    listen 80;
    listen [::]:80;
    server_name api.star-graph.com;
    
    # 强制HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.star-graph.com;
    
    # SSL证书
    ssl_certificate /etc/ssl/certs/star-graph.crt;
    ssl_certificate_key /etc/ssl/private/star-graph.key;
    
    # SSL配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # 安全头
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # API代理
    location /api {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # 缓冲配置
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }
    
    # WebSocket代理
    location /ws {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # WebSocket超时
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }
    
    # 静态文件
    location / {
        root /var/www/star-graph;
        try_files $uri $uri/ /index.html;
        
        # 缓存配置
        location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
    }
}
```

### 6.2 数据库主从复制

**主库配置**:
```ini
# /etc/mysql/mysql.conf.d/master.cnf
[mysqld]
server-id = 1
log_bin = mysql-bin
binlog_format = ROW
binlog_do_db = star_graph
```

**从库配置**:
```ini
# /etc/mysql/mysql.conf.d/slave.cnf
[mysqld]
server-id = 2
relay_log = relay-bin
read_only = 1
```

配置复制:
```sql
-- 主库执行
CREATE USER 'replication'@'%' IDENTIFIED BY 'ReplicationPassword';
GRANT REPLICATION SLAVE ON *.* TO 'replication'@'%';
FLUSH PRIVILEGES;
SHOW MASTER STATUS;

-- 从库执行
CHANGE MASTER TO
    MASTER_HOST='master.star-graph.com',
    MASTER_USER='replication',
    MASTER_PASSWORD='ReplicationPassword',
    MASTER_LOG_FILE='mysql-bin.000001',
    MASTER_LOG_POS=154;

START SLAVE;
SHOW SLAVE STATUS\G;
```

### 6.3 Redis集群

```bash
# 创建Redis集群
redis-cli --cluster create \
    192.168.1.101:7000 \
    192.168.1.102:7000 \
    192.168.1.103:7000 \
    192.168.1.101:7001 \
    192.168.1.102:7001 \
    192.168.1.103:7001 \
    --cluster-replicas 1 \
    -a YourRedisPassword
```

### 6.4 CDN配置

```yaml
# CDN加速配置
CDN配置:
  域名: cdn.star-graph.com
  源站: origin.star-graph.com
  缓存规则:
    - 路径: /images/*
      TTL: 7天
    - 路径: /videos/*
      TTL: 30天
    - 路径: /api/*
      TTL: 不缓存
  安全配置:
    - 防盗链
    - Token鉴权
    - IP黑白名单
```

## 7. 监控与运维

### 7.1 Prometheus监控

```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  
scrape_configs:
  - job_name: 'star-graph'
    static_configs:
      - targets: 
        - 'localhost:8080'
    metrics_path: '/actuator/prometheus'
    
  - job_name: 'node-exporter'
    static_configs:
      - targets: 
        - 'localhost:9100'
        
  - job_name: 'mysql-exporter'
    static_configs:
      - targets: 
        - 'localhost:9104'
```

### 7.2 Grafana仪表板

```json
{
  "dashboard": {
    "title": "Star-Graph监控",
    "panels": [
      {
        "title": "请求QPS",
        "targets": [
          {
            "expr": "rate(http_requests_total[1m])"
          }
        ]
      },
      {
        "title": "响应时间",
        "targets": [
          {
            "expr": "http_request_duration_seconds{quantile=\"0.99\"}"
          }
        ]
      },
      {
        "title": "CPU使用率",
        "targets": [
          {
            "expr": "100 - (avg(irate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)"
          }
        ]
      }
    ]
  }
}
```

### 7.3 日志管理

**ELK配置**:
```yaml
# logstash.conf
input {
  beats {
    port => 5044
  }
}

filter {
  if [fields][service] == "star-graph" {
    grok {
      match => {
        "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} %{DATA:logger} - %{GREEDYDATA:message}"
      }
    }
  }
}

output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "star-graph-%{+YYYY.MM.dd}"
  }
}
```

### 7.4 告警配置

```yaml
# alertmanager.yml
global:
  smtp_from: 'alert@star-graph.com'
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_auth_username: 'alert@star-graph.com'
  smtp_auth_password: 'password'

route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'email-notifications'

receivers:
- name: 'email-notifications'
  email_configs:
  - to: 'admin@star-graph.com'
    headers:
      Subject: 'Star-Graph Alert: {{ .GroupLabels.alertname }}'
```

## 8. 故障排查

### 8.1 常见问题

**问题1: 无法连接数据库**
```bash
# 检查数据库状态
systemctl status mysql
mysql -u root -p -e "SHOW PROCESSLIST;"

# 检查连接数
mysql -u root -p -e "SHOW VARIABLES LIKE 'max_connections';"
mysql -u root -p -e "SHOW STATUS LIKE 'Threads_connected';"

# 解决方案
vim /etc/mysql/mysql.conf.d/mysqld.cnf
# 修改 max_connections = 500
systemctl restart mysql
```

**问题2: Redis连接超时**
```bash
# 检查Redis状态
redis-cli -a YourRedisPassword ping
redis-cli -a YourRedisPassword INFO clients

# 检查配置
redis-cli -a YourRedisPassword CONFIG GET timeout
redis-cli -a YourRedisPassword CONFIG GET maxclients

# 解决方案
redis-cli -a YourRedisPassword CONFIG SET timeout 0
redis-cli -a YourRedisPassword CONFIG SET maxclients 10000
```

**问题3: 内存不足**
```bash
# 检查内存使用
free -h
top -b -n 1 | head -20

# 检查Java堆内存
jmap -heap <pid>

# 解决方案
# 修改JVM参数
java -Xms4g -Xmx8g -jar app.jar
```

### 8.2 性能问题排查

```bash
# CPU分析
top -H -p <pid>
jstack <pid> > thread_dump.txt

# 内存分析
jmap -dump:format=b,file=heap.dump <pid>
jhat heap.dump

# 网络分析
netstat -antp | grep 8080
ss -s
tcpdump -i eth0 port 8080

# 磁盘I/O分析
iostat -x 1
iotop
```

### 8.3 日志分析

```bash
# 查看应用日志
tail -f /var/log/star-graph/app.log

# 查看错误日志
grep ERROR /var/log/star-graph/app.log | tail -100

# 查看慢查询
grep "took [0-9]\{4,\}ms" /var/log/star-graph/app.log

# 统计错误类型
awk '/ERROR/ {print $5}' /var/log/star-graph/app.log | sort | uniq -c | sort -rn
```

## 9. 性能优化

### 9.1 JVM优化

```bash
# JVM启动参数优化
JAVA_OPTS="-server \
  -Xms4g \
  -Xmx8g \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \
  -XX:+ParallelRefProcEnabled \
  -XX:+HeapDumpOnOutOfMemoryError \
  -XX:HeapDumpPath=/var/log/star-graph/heap_dump.hprof \
  -Xloggc:/var/log/star-graph/gc.log \
  -XX:+PrintGCDetails \
  -XX:+PrintGCDateStamps"

java $JAVA_OPTS -jar app.jar
```

### 9.2 数据库优化

```sql
-- 添加索引
ALTER TABLE tasks ADD INDEX idx_user_status (user_id, status);
ALTER TABLE sg_user_fund ADD INDEX idx_user_create (user_id, create_time);

-- 查询优化
EXPLAIN SELECT * FROM tasks WHERE user_id = 1001 AND status = 'COMPLETED';

-- 配置优化
SET GLOBAL innodb_buffer_pool_size = 4G;
SET GLOBAL query_cache_size = 256M;
SET GLOBAL query_cache_type = 1;
```

### 9.3 Redis优化

```bash
# 配置优化
redis-cli -a YourRedisPassword CONFIG SET maxmemory 4gb
redis-cli -a YourRedisPassword CONFIG SET maxmemory-policy allkeys-lru
redis-cli -a YourRedisPassword CONFIG SET tcp-keepalive 60

# 持久化优化
redis-cli -a YourRedisPassword CONFIG SET save "900 1 300 10 60 10000"
redis-cli -a YourRedisPassword CONFIG SET appendonly yes
redis-cli -a YourRedisPassword CONFIG SET appendfsync everysec
```

### 9.4 系统优化

```bash
# 内核参数优化
cat >> /etc/sysctl.conf << EOF
# 网络优化
net.ipv4.tcp_max_syn_backlog = 8192
net.core.somaxconn = 8192
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 30

# 文件系统优化
fs.file-max = 1000000
fs.nr_open = 1000000

# 内存优化
vm.swappiness = 10
vm.dirty_background_ratio = 5
vm.dirty_ratio = 10
EOF

sysctl -p
```

## 10. 备份与恢复

### 10.1 数据库备份

```bash
#!/bin/bash
# backup-mysql.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/mysql"
DB_NAME="star_graph"
DB_USER="root"
DB_PASS="password"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 全量备份
mysqldump -u$DB_USER -p$DB_PASS --single-transaction --routines --triggers --events $DB_NAME > $BACKUP_DIR/backup_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/backup_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

# 上传到远程存储(可选)
# aws s3 cp $BACKUP_DIR/backup_$DATE.sql.gz s3://backup-bucket/mysql/
```

### 10.2 Redis备份

```bash
#!/bin/bash
# backup-redis.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/redis"
REDIS_CLI="redis-cli -a YourRedisPassword"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 执行BGSAVE
$REDIS_CLI BGSAVE

# 等待备份完成
while [ $($REDIS_CLI LASTSAVE) -eq $($REDIS_CLI LASTSAVE) ]; do
  sleep 1
done

# 复制RDB文件
cp /var/lib/redis/dump.rdb $BACKUP_DIR/dump_$DATE.rdb

# 压缩备份文件
gzip $BACKUP_DIR/dump_$DATE.rdb
```

### 10.3 应用备份

```bash
#!/bin/bash
# backup-app.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/app"
APP_DIR="/opt/star-graph"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份应用文件
tar czf $BACKUP_DIR/app_$DATE.tar.gz -C $APP_DIR .

# 备份配置文件
tar czf $BACKUP_DIR/config_$DATE.tar.gz /etc/star-graph/

# 备份日志文件
tar czf $BACKUP_DIR/logs_$DATE.tar.gz /var/log/star-graph/
```

### 10.4 恢复流程

**数据库恢复**:
```bash
# 解压备份文件
gunzip backup_20241002_120000.sql.gz

# 恢复数据库
mysql -u root -p star_graph < backup_20241002_120000.sql

# 验证恢复
mysql -u root -p -e "USE star_graph; SHOW TABLES;"
```

**Redis恢复**:
```bash
# 停止Redis
systemctl stop redis

# 恢复RDB文件
gunzip dump_20241002_120000.rdb.gz
cp dump_20241002_120000.rdb /var/lib/redis/dump.rdb

# 启动Redis
systemctl start redis

# 验证恢复
redis-cli -a YourRedisPassword DBSIZE
```

### 10.5 定时备份

```bash
# 添加到crontab
crontab -e

# 每天凌晨2点备份数据库
0 2 * * * /backup/scripts/backup-mysql.sh

# 每6小时备份Redis
0 */6 * * * /backup/scripts/backup-redis.sh

# 每周日凌晨3点备份应用
0 3 * * 0 /backup/scripts/backup-app.sh
```

## 总结

Star-Graph部署指南涵盖了从开发环境到生产环境的完整部署流程：

1. **开发环境**: 快速搭建，便于开发调试
2. **Docker部署**: 容器化部署，环境一致性
3. **Kubernetes**: 云原生部署，自动化运维
4. **生产部署**: 高可用架构，性能优化
5. **监控运维**: 全方位监控，及时告警
6. **故障排查**: 问题定位，快速恢复
7. **备份恢复**: 数据安全，灾难恢复

通过本指南，您可以根据实际需求选择合适的部署方案，确保Star-Graph平台稳定、高效地运行。